import { minifyJson, prettyJson } from './jsonUtils.js';
import {
    showJsonDiffPopup, showTextInputPopup, showConfirmationPopup, showCustomFormPopup,
    showUrlProcessPopup, showTemplateSelectionPopup, showTemplateContentPopup, showTemplateManagementPopup
} from './customPopup.js';
import {
    jsonInputField, saveFeedback, errorOutput, treeViewContainer, tableViewContainer,
    showTemporaryMessage, updateTableViewPathDisplay, resetBaseUI
} from './domUtils.js';
import { getObjectByPath, convertToTypedValue } from './dataUtils.js';
import { buildTree, selectNode, getSelectedNodePath, getExpandedNodePaths, expandNodesByPath } from './treeView.js';
import { applyValueStyleToNode } from './treeViewStyleUtils.js';
import { displayDataWithHandsontable as displayTableInHot, destroyHotInstance } from './tableViewHandsontable.js';
import * as historyManager from './historyManager.js';
import * as searchController from './searchController.js';
import * as templateManager from './templateManager.js';
import { initializeThemeSwitcher } from './theme-switcher.js';
import { initVisualSchemaEditor } from './visualSchemaEditor.js';

let currentJsonData = null;
let originalJsonDataAtLoad = null;
let searchInput, searchTargetSelect, searchResultsDropdown;
let hotInstanceRefForPopups = null;

const mainLayoutTriplePanel = document.querySelector('.main-layout-triple-panel');
const schemaEditorPanelContainer = document.getElementById('schemaEditorPanelContainer');
const toggleSchemaEditorBtn = document.getElementById('toggleSchemaEditorBtn');

let isSchemaEditorVisible = false;

function encodeUrlString(str) {
    if (typeof str !== 'string') { throw new TypeError('ÏûÖÎ†•Í∞íÏùÄ Î¨∏ÏûêÏó¥Ïù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.'); }
    try { return encodeURIComponent(str); }
    catch (e) { console.error("URL Ïù∏ÏΩîÎî© Ï§ë Ïò§Î•ò Î∞úÏÉù:", e); throw e; }
}

function decodeUrlString(encodedStr) {
    if (typeof encodedStr !== 'string') { throw new TypeError('ÏûÖÎ†•Í∞íÏùÄ Î¨∏ÏûêÏó¥Ïù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.'); }
    try { return decodeURIComponent(encodedStr); }
    catch (e) { console.error("URL ÎîîÏΩîÎî© Ï§ë Ïò§Î•ò Î∞úÏÉù:", e); throw e; }
}

async function openTemplateManagement() {
    const refreshManagementPopup = async (message = '', messageType = 'success') => {
        if (message && saveFeedback) showTemporaryMessage(saveFeedback, message, 2500, messageType);
        await new Promise(resolve => setTimeout(resolve, 50));
        openTemplateManagement();
    };

    const currentUserTemplates = templateManager.getUserTemplates();

    await showTemplateManagementPopup({
        userTemplates: currentUserTemplates,
        callbacks: {
            onViewRequest: async (templateName) => {
                const template = templateManager.getUserTemplates().find(t => t.name === templateName);
                if (template) {
                    await showTemplateContentPopup({
                        templateName: template.name,
                        templateValue: template.value,
                        hotInstance: hotInstanceRefForPopups
                    });
                }
                await refreshManagementPopup('ÌÖúÌîåÎ¶ø ÎÇ¥Ïö©ÏùÑ ÌôïÏù∏ÌñàÏäµÎãàÎã§.', 'info');
            },
            onRenameRequest: async (oldName) => {
                const templateToRename = templateManager.getUserTemplates().find(t => t.name === oldName);
                if (!templateToRename) {
                    await refreshManagementPopup('Î≥ÄÍ≤ΩÌï† ÌÖúÌîåÎ¶øÏùÑ Ï∞æÏßÄ Î™ªÌñàÏäµÎãàÎã§.', 'error');
                    return;
                }
                const renameResult = await showTextInputPopup({
                    title: `'${oldName}' ÌÖúÌîåÎ¶ø Ïù¥Î¶Ñ Î≥ÄÍ≤Ω`,
                    inputLabel: 'ÏÉàÎ°úÏö¥ ÌÖúÌîåÎ¶ø Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:',
                    inputValue: oldName,
                    confirmButtonText: 'Î≥ÄÍ≤Ω Ï†ÄÏû•',
                    inputValidator: (value) => {
                        const newName = value.trim();
                        if (!newName) return 'ÌÖúÌîåÎ¶ø Ïù¥Î¶ÑÏùÄ ÎπÑÏõåÎëò Ïàò ÏóÜÏäµÎãàÎã§.';
                        if (newName === oldName) return null;
                        if (templateManager.getTemplates().some(t => t.name === newName)) {
                            return `'${newName}' Ïù¥Î¶ÑÏùÄ Ïù¥ÎØ∏ ÏÇ¨Ïö© Ï§ëÏûÖÎãàÎã§.`;
                        }
                        return null;
                    },
                    hotInstance: hotInstanceRefForPopups
                });

                if (renameResult.isConfirmed && typeof renameResult.value === 'string') {
                    const newName = renameResult.value.trim();
                    if (newName === oldName) {
                        await refreshManagementPopup('Ïù¥Î¶ÑÏù¥ Î≥ÄÍ≤ΩÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.', 'info');
                        return;
                    }
                    const resultStatus = templateManager.renameUserTemplate(oldName, newName);
                    if (resultStatus === true) {
                        await refreshManagementPopup(`ÌÖúÌîåÎ¶ø '${oldName}'Ïù¥(Í∞Ä) '${newName}'(Ïúº)Î°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`);
                    } else {
                        let errorMsg = 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÎ°ú Ïù¥Î¶Ñ Î≥ÄÍ≤ΩÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.';
                        if (resultStatus === 'empty_name') errorMsg = 'ÏÉà ÌÖúÌîåÎ¶ø Ïù¥Î¶ÑÏùÄ ÎπÑÏõåÎëò Ïàò ÏóÜÏäµÎãàÎã§.';
                        else if (resultStatus === 'not_found') errorMsg = `ÌÖúÌîåÎ¶ø '${oldName}'ÏùÑ(Î•º) Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.`;
                        else if (resultStatus === 'duplicate_name') errorMsg = `ÏÉà Ïù¥Î¶Ñ '${newName}'ÏùÄ(Îäî) Ïù¥ÎØ∏ ÏÇ¨Ïö© Ï§ëÏûÖÎãàÎã§.`;
                        else if (resultStatus === 'default_conflict') errorMsg = `ÏÉà Ïù¥Î¶Ñ '${newName}'ÏùÄ(Îäî) Í∏∞Î≥∏ ÌÖúÌîåÎ¶ø Ïù¥Î¶ÑÍ≥º Ï∂©ÎèåÌï©ÎãàÎã§.`;
                        await showConfirmationPopup({title: 'Ïù¥Î¶Ñ Î≥ÄÍ≤Ω Ïò§Î•ò', text: errorMsg, icon: 'error', showCancelButton:false, hotInstance: hotInstanceRefForPopups});
                        await refreshManagementPopup('Ïù¥Î¶Ñ Î≥ÄÍ≤Ω Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                    }
                } else {
                    await refreshManagementPopup('Ïù¥Î¶Ñ Î≥ÄÍ≤ΩÏù¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.', 'info');
                }
            },
            onDeleteRequest: async (templateName) => {
                const confirmation = await showConfirmationPopup({
                    title: `'${templateName}' ÌÖúÌîåÎ¶ø ÏÇ≠Ï†ú`,
                    text: `Ï†ïÎßêÎ°ú '${templateName}' ÌÖúÌîåÎ¶øÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.`,
                    icon: 'warning', showCancelButton: true, confirmButtonText: 'ÏÇ≠Ï†ú', cancelButtonText: 'Ï∑®ÏÜå',
                    hotInstance: hotInstanceRefForPopups
                });

                if (confirmation.isConfirmed) {
                    const success = templateManager.deleteUserTemplate(templateName);
                    if (success) {
                        await refreshManagementPopup(`ÌÖúÌîåÎ¶ø '${templateName}'Ïù¥(Í∞Ä) ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`);
                    } else {
                        await showConfirmationPopup({title: 'ÏÇ≠Ï†ú Ïò§Î•ò', text: `ÌÖúÌîåÎ¶ø '${templateName}' ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.`, icon: 'error', showCancelButton:false, hotInstance: hotInstanceRefForPopups});
                        await refreshManagementPopup('ÏÇ≠Ï†ú Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                    }
                } else {
                    await refreshManagementPopup('ÏÇ≠Ï†úÍ∞Ä Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.', 'info');
                }
            }
        },
        hotInstance: hotInstanceRefForPopups
    });
}

function showMainJsonEditorView() {
    if (mainLayoutTriplePanel) mainLayoutTriplePanel.style.display = 'flex';
    if (schemaEditorPanelContainer) schemaEditorPanelContainer.style.display = 'none';
    if (toggleSchemaEditorBtn) toggleSchemaEditorBtn.textContent = 'üìú Ïä§ÌÇ§Îßà Ìé∏ÏßëÍ∏∞';
    isSchemaEditorVisible = false;
}

function showSchemaEditorView() {
    if (mainLayoutTriplePanel) mainLayoutTriplePanel.style.display = 'none';
    if (schemaEditorPanelContainer) {
        schemaEditorPanelContainer.style.display = 'flex';

        const editorContentArea = document.getElementById('schema-editor-content-area');
        const mainSchemaTextarea = document.getElementById('jsonSchema');

        let initialSchemaForEditor = {
            $schema: "http://json-schema.org/draft-07/schema#",
            type: "object",
            properties: {},
            description: ""
        };
        if (mainSchemaTextarea && mainSchemaTextarea.value) {
            try {
                const parsedSchema = JSON.parse(mainSchemaTextarea.value);
                if (typeof parsedSchema === 'object' && parsedSchema !== null) {
                    initialSchemaForEditor = parsedSchema;
                } else {
                    console.warn("Î©îÏù∏ Ïä§ÌÇ§Îßà ÌÖçÏä§Ìä∏ ÏòÅÏó≠Ïùò ÎÇ¥Ïö©Ïù¥ Ïú†Ìö®Ìïú Í∞ùÏ≤¥Í∞Ä ÏïÑÎãàÎØÄÎ°ú Í∏∞Î≥∏ Ïä§ÌÇ§ÎßàÎ°ú Ï¥àÍ∏∞ÌôîÌï©ÎãàÎã§.");
                }
            } catch (e) {
                console.warn("Î©îÏù∏ Ïä§ÌÇ§Îßà ÌÖçÏä§Ìä∏ ÏòÅÏó≠ ÌååÏã± Ïã§Ìå®, Í∏∞Î≥∏ Ïä§ÌÇ§ÎßàÎ°ú ÏãúÍ∞ÅÏ†Å Ìé∏ÏßëÍ∏∞ Ï¥àÍ∏∞Ìôî:", e.message);
            }
        }

        if(editorContentArea){
            initVisualSchemaEditor(editorContentArea, initialSchemaForEditor, (updatedSchema) => {
                if (mainSchemaTextarea) {
                    mainSchemaTextarea.value = JSON.stringify(updatedSchema, null, 2);
                }
            });
        } else {
            console.error("Schema editor content area ('schema-editor-content-area') not found.");
        }
    }
    if (toggleSchemaEditorBtn) toggleSchemaEditorBtn.textContent = 'JSON Ìé∏ÏßëÍ∏∞Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞';
    isSchemaEditorVisible = true;
}

function initialLoad() {
    const loadBtn = document.getElementById("loadBtn");
    if (loadBtn) loadBtn.addEventListener("click", loadJson);

    const saveBtn = document.getElementById("saveBtn");
    if (saveBtn) saveBtn.addEventListener('click', saveJson);

    const minifyBtn = document.getElementById("minifyBtn");
    if (minifyBtn) {
        minifyBtn.addEventListener("click", () => {
            if (jsonInputField && jsonInputField.value) {
                try { jsonInputField.value = minifyJson(jsonInputField.value); }
                catch (e) { if(errorOutput) errorOutput.textContent = 'Minify Ïò§Î•ò: ' + e.message; }
            } else if (jsonInputField) { jsonInputField.value = ""; }
        });
    }

    const uglifyBtn = document.getElementById("uglifyBtn");
    if (uglifyBtn) {
        uglifyBtn.addEventListener("click", () => {
            if (jsonInputField && jsonInputField.value) {
                try { jsonInputField.value = prettyJson(jsonInputField.value); }
                catch (e) { if(errorOutput) errorOutput.textContent = 'Uglify(Ìè¨Îß∑ÌåÖ) Ïò§Î•ò: ' + e.message; }
            } else if (jsonInputField) { jsonInputField.value = ""; }
        });
    }

    const diffBtn = document.getElementById("diffBtn");
    if (diffBtn) {
        diffBtn.addEventListener('click', () => {
            if (!originalJsonDataAtLoad && !currentJsonData) {
                showConfirmationPopup({ title: 'ÏïåÎ¶º', text: 'Î®ºÏ†Ä JSON Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌï¥Ï£ºÏÑ∏Ïöî.', icon: 'info', showCancelButton: false, hotInstance: hotInstanceRefForPopups }); return;
            }
            if (!originalJsonDataAtLoad) {
                showConfirmationPopup({ title: 'ÏïåÎ¶º', text: 'Î°úÎìú ÏãúÏ†êÏùò ÏõêÎ≥∏ JSON Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.', icon: 'info', showCancelButton: false, hotInstance: hotInstanceRefForPopups }); return;
            }
            const dataForDiffRight = currentJsonData === null ? {} : currentJsonData;
            showJsonDiffPopup({
                title: 'JSON Îç∞Ïù¥ÌÑ∞ Î≥ÄÍ≤ΩÏÇ¨Ìï≠', jsonDiffData: { left: originalJsonDataAtLoad, right: dataForDiffRight },
                buttons: [{ text: 'Îã´Í∏∞', role: 'confirm' }], hotInstance: hotInstanceRefForPopups
            }).catch(error => {
                showConfirmationPopup({ title: 'Ïò§Î•ò', text: 'Î≥ÄÍ≤ΩÏ†ê ÌôïÏù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', icon: 'error', showCancelButton: false, hotInstance: hotInstanceRefForPopups });
            });
        });
    }

    const loadFromFileButton = document.getElementById("loadFromFileBtn");
    if (loadFromFileButton) loadFromFileButton.addEventListener("click", loadJsonFromFile);

    const saveToFileButton = document.getElementById("saveToFileBtn");
    if (saveToFileButton) saveToFileButton.addEventListener("click", saveJsonToFile);

    const saveToCSVButton = document.getElementById("saveToCSV");
    if (saveToCSVButton) saveToCSVButton.addEventListener("click", saveJsonToCSV);

    const loadFromCSVButton = document.getElementById("loadFromCSV");
    if (loadFromCSVButton) loadFromCSVButton.addEventListener("click", loadCsvFromFile);

    const loadTemplatesFromFileBtn = document.getElementById("loadTemplatesFromFileBtn");
    if (loadTemplatesFromFileBtn) loadTemplatesFromFileBtn.addEventListener("click", loadTemplatesFromFile);

    const saveTemplatesToFileBtn = document.getElementById("saveTemplatesToFileBtn");
    if (saveTemplatesToFileBtn) saveTemplatesToFileBtn.addEventListener("click", saveTemplatesToFile);

    const manageTemplatesBtn = document.getElementById("manageTemplatesBtn");
    if (manageTemplatesBtn) manageTemplatesBtn.addEventListener('click', openTemplateManagement);

    const encodeUrlBtn = document.getElementById("encodeUrlBtn");
    if (encodeUrlBtn) {
        encodeUrlBtn.addEventListener("click", async () => {
            const initialVal = jsonInputField ? jsonInputField.value : '';
            try {
                const result = await showUrlProcessPopup({
                    title: 'URL Ïù∏ÏΩîÎî©', initialInputValue: initialVal, inputLabel: 'Ïù∏ÏΩîÎî©Ìï† ÏõêÎ≥∏ Î¨∏ÏûêÏó¥:', outputLabel: 'Ïù∏ÏΩîÎî©Îêú Í≤∞Í≥º:', actionButtonText: 'Ïù∏ÏΩîÎî© Ïã§Ìñâ',
                    onExecuteAction: (inputValue) => { try { return encodeUrlString(inputValue); } catch (e) { return `Ïò§Î•ò: ${e.message}`; } },
                    confirmButtonText: 'Í≤∞Í≥ºÎ•º Î©îÏù∏ Ìé∏ÏßëÍ∏∞Ïóê Î≥µÏÇ¨', cancelButtonText: 'ÌåùÏóÖ Îã´Í∏∞', hotInstance: hotInstanceRefForPopups
                });
                if (result.isConfirmed && result.formData && result.formData !== false) {
                    if (jsonInputField) { jsonInputField.value = result.formData; if(saveFeedback) showTemporaryMessage(saveFeedback, 'Í≤∞Í≥ºÍ∞Ä Î©îÏù∏ Ìé∏ÏßëÍ∏∞Ïóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.', 2000); }
                } else if (result.isDismissed && result.dismiss === 'cancel') { if(saveFeedback) showTemporaryMessage(saveFeedback, 'URL Ïù∏ÏΩîÎî© ÏûëÏóÖÏ∞ΩÏùÑ Îã´ÏïòÏäµÎãàÎã§.', 1500, 'info'); }
            } catch (error) {
                if(errorOutput) errorOutput.textContent = 'URL Ïù∏ÏΩîÎî© ÌåùÏóÖ Ïò§Î•ò: ' + error.message;
                if(saveFeedback) showTemporaryMessage(saveFeedback, 'URL Ïù∏ÏΩîÎî© ÌåùÏóÖ Ï≤òÎ¶¨ Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 3000, 'error');
            }
        });
    }

    const decodeUrlBtn = document.getElementById("decodeUrlBtn");
    if (decodeUrlBtn) {
        decodeUrlBtn.addEventListener("click", async () => {
            const initialVal = jsonInputField ? jsonInputField.value : '';
            try {
                const result = await showUrlProcessPopup({
                    title: 'URL ÎîîÏΩîÎî©', initialInputValue: initialVal, inputLabel: 'ÎîîÏΩîÎî©Ìï† URL Ïù∏ÏΩîÎî©Îêú Î¨∏ÏûêÏó¥:', outputLabel: 'ÎîîÏΩîÎî©Îêú Í≤∞Í≥º:', actionButtonText: 'ÎîîÏΩîÎî© Ïã§Ìñâ',
                    onExecuteAction: (inputValue) => { try { return decodeUrlString(inputValue); } catch (e) { return `Ïò§Î•ò: ${e.message}`; } },
                    confirmButtonText: 'Í≤∞Í≥ºÎ•º Î©îÏù∏ Ìé∏ÏßëÍ∏∞Ïóê Î≥µÏÇ¨', cancelButtonText: 'ÌåùÏóÖ Îã´Í∏∞', hotInstance: hotInstanceRefForPopups
                });
                if (result.isConfirmed && result.formData && result.formData !== false) {
                    if (jsonInputField) { jsonInputField.value = result.formData; if(saveFeedback) showTemporaryMessage(saveFeedback, 'Í≤∞Í≥ºÍ∞Ä Î©îÏù∏ Ìé∏ÏßëÍ∏∞Ïóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.', 2000); }
                } else if (result.isDismissed && result.dismiss === 'cancel') { if(saveFeedback) showTemporaryMessage(saveFeedback, 'URL ÎîîÏΩîÎî© ÏûëÏóÖÏ∞ΩÏùÑ Îã´ÏïòÏäµÎãàÎã§.', 1500, 'info'); }
            } catch (error) {
                if(errorOutput) errorOutput.textContent = 'URL ÎîîÏΩîÎî© ÌåùÏóÖ Ïò§Î•ò: ' + error.message;
                if(saveFeedback) showTemporaryMessage(saveFeedback, 'URL ÎîîÏΩîÎî© ÌåùÏóÖ Ï≤òÎ¶¨ Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 3000, 'error');
            }
        });
    }

    searchInput = document.getElementById('searchInput');
    searchTargetSelect = document.getElementById('searchTargetSelect');
    searchResultsDropdown = document.getElementById('searchResultsDropdown');

    if (searchInput) searchInput.addEventListener('input', handleSearchInput);
    if (searchTargetSelect) searchTargetSelect.addEventListener('change', handleSearchInput);

    document.addEventListener('click', (event) => {
        if (searchResultsDropdown && searchInput && !searchInput.contains(event.target) && !searchResultsDropdown.contains(event.target)) {
            searchResultsDropdown.style.display = 'none';
        }
    });
    if (searchResultsDropdown) searchResultsDropdown.addEventListener('click', (event) => event.stopPropagation());

    window.addEventListener('mouseup', (event) => {
        if (event.button === 3 || event.button === 4) {
            event.preventDefault();
            if (event.button === 3) navigateHistory('back');
            else if (event.button === 4) navigateHistory('forward');
        }
    });
    window.addEventListener('contextmenu', (event) => { event.preventDefault(); });

    const jsonControlPanel = document.querySelector('.json-control-panel');
    if (jsonControlPanel) {
        jsonControlPanel.addEventListener('dragover', handleDragOver);
        jsonControlPanel.addEventListener('dragleave', handleDragLeave);
        jsonControlPanel.addEventListener('drop', handleFileDrop);
    } else { console.warn('.json-control-panel ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏñ¥ ÎìúÎûòÍ∑∏Ïï§ÎìúÎ°≠ Í∏∞Îä•ÏùÑ ÌôúÏÑ±ÌôîÌï† Ïàò ÏóÜÏäµÎãàÎã§.'); }

    const panelContainer = document.querySelector('.main-layout-triple-panel');
    const panels = [ document.querySelector('.json-control-panel'), document.querySelector('.tree-view-panel'), document.querySelector('.table-view-panel') ];
    const resizers = [ document.getElementById('resizer-1'), document.getElementById('resizer-2') ];

    if (panelContainer && panels.every(p => p) && resizers.every(r => r)) {
        setInitialPanelWidths(panelContainer, panels, resizers);
        window.addEventListener('resize', () => setInitialPanelWidths(panelContainer, panels, resizers));
        resizers.forEach((resizer, index) => {
            let isResizing = false; let startX = 0; let initialWidths = [];
            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault(); isResizing = true; startX = e.clientX; initialWidths = [panels[index].offsetWidth, panels[index + 1].offsetWidth];
                document.addEventListener('mousemove', handleMouseMove); document.addEventListener('mouseup', handleMouseUp);
            });
            function handleMouseMove(e) {
                if (!isResizing) return; const deltaX = e.clientX - startX; const minPanelWidth = 50;
                let newLeftWidth = initialWidths[0] + deltaX; let newRightWidth = initialWidths[1] - deltaX;
                if (newLeftWidth < minPanelWidth) { newLeftWidth = minPanelWidth; newRightWidth = initialWidths[0] + initialWidths[1] - newLeftWidth; }
                if (newRightWidth < minPanelWidth) { newRightWidth = minPanelWidth; newLeftWidth = initialWidths[0] + initialWidths[1] - newRightWidth; }
                panels[index].style.flexBasis = `${newLeftWidth}px`; panels[index + 1].style.flexBasis = `${newRightWidth}px`;
            }
            function handleMouseUp() {
                if (!isResizing) return; isResizing = false;
                document.removeEventListener('mousemove', handleMouseMove); document.removeEventListener('mouseup', handleMouseUp);
            }
        });
    } else { console.warn('3-Ìå®ÎÑê Î†àÏù¥ÏïÑÏõÉÏóê ÌïÑÏöîÌïú ÏöîÏÜåÎ•º Î™®Îëê Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Î¶¨ÏÇ¨Ïù¥Ï†ÄÍ∞Ä ÎèôÏûëÌïòÏßÄ ÏïäÏùÑ Ïàò ÏûàÏäµÎãàÎã§.'); }

    if (toggleSchemaEditorBtn) {
        toggleSchemaEditorBtn.addEventListener('click', () => {
            if (isSchemaEditorVisible) {
                showMainJsonEditorView();
            } else {
                showSchemaEditorView();
            }
        });
    }

    initializeThemeSwitcher();
}

function handleDragOver(event) {
    event.preventDefault(); event.stopPropagation();
    if (event.currentTarget && typeof event.currentTarget.classList !== 'undefined') event.currentTarget.classList.add('dragover-active');
    event.dataTransfer.dropEffect = 'copy';
}

function handleDragLeave(event) {
    event.preventDefault(); event.stopPropagation();
    if (event.currentTarget && typeof event.currentTarget.classList !== 'undefined') event.currentTarget.classList.remove('dragover-active');
}

function handleFileDrop(event) {
    event.preventDefault(); event.stopPropagation();
    if (event.currentTarget && typeof event.currentTarget.classList !== 'undefined') event.currentTarget.classList.remove('dragover-active');
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        const file = files[0];
        if (file.type === "application/json" || file.name.toLowerCase().endsWith('.json')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const fileContent = e.target.result;
                    if (jsonInputField) {
                        jsonInputField.value = fileContent; loadJson();
                        showTemporaryMessage(saveFeedback, `${file.name} ÌååÏùºÏù¥ ÎìúÎ°≠ÎêòÏñ¥ Î°úÎìúÎêòÏóàÏäµÎãàÎã§.`, 3000);
                    } else { showConfirmationPopup({ title: 'Ïò§Î•ò', text: 'JSON ÏûÖÎ†• ÌïÑÎìúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', icon: 'error', showCancelButton: false, hotInstance: hotInstanceRefForPopups }); }
                } catch (err) {
                    if(errorOutput) errorOutput.textContent = `ÌååÏùº Ïò§Î•ò (ÎìúÎ°≠): ${err.message}`;
                    showConfirmationPopup({ title: 'ÌååÏùº Î°úÎìú Ïò§Î•ò (ÎìúÎ°≠)', text: `ÌååÏùºÏùÑ Î°úÎìúÌïòÍ±∞ÎÇò ÌååÏã±ÌïòÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${err.message}`, icon: 'error', showCancelButton: false, hotInstance: hotInstanceRefForPopups });
                }
            };
            reader.onerror = () => {
                if(errorOutput) errorOutput.textContent = 'ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§ (ÎìúÎ°≠).';
                showConfirmationPopup({ title: 'ÌååÏùº ÏùΩÍ∏∞ Ïò§Î•ò (ÎìúÎ°≠)', text: 'ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', icon: 'error', showCancelButton: false, hotInstance: hotInstanceRefForPopups });
            };
            reader.readAsText(file);
        } else { showConfirmationPopup({ title: 'ÏûòÎ™ªÎêú ÌååÏùº ÌÉÄÏûÖ', text: 'JSON ÌååÏùº(.json)Îßå ÎìúÎ°≠Ìï¥Ï£ºÏÑ∏Ïöî.', icon: 'warning', showCancelButton: false, hotInstance: hotInstanceRefForPopups }); }
    }
}

function setInitialPanelWidths(container, panelsArray, resizersArray) {
    const containerWidth = container.offsetWidth;
    const totalResizerWidth = resizersArray.reduce((sum, r) => sum + r.offsetWidth, 0);
    const availableWidth = containerWidth - totalResizerWidth;
    const ratios = [0.15, 0.15, 0.70];
    const minW = 50;

    if (availableWidth > 0) {
        let w1 = Math.max(minW, Math.floor(availableWidth * ratios[0]));
        let w2 = Math.max(minW, Math.floor(availableWidth * ratios[1]));
        let w3 = Math.max(minW, availableWidth - w1 - w2); // w3Îäî w1, w2 Í≤∞Ï†ï ÌõÑ ÎÇ®ÏùÄ Í≥µÍ∞ÑÏúºÎ°ú Ï¥àÍ∏∞ Í≥ÑÏÇ∞

        // ÎÑàÎπÑÏùò Ìï©Ïù¥ ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ï†ÑÏ≤¥ ÎÑàÎπÑÎ•º Ï¥àÍ≥ºÌïòÎäî Í≤ΩÏö∞ Ï°∞Ï†ï
        if (w1 + w2 + w3 > availableWidth) {
            // w3Î•º Î®ºÏ†Ä ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Í≥µÍ∞ÑÏóê ÎßûÍ≤å Ïû¨Ï°∞Ï†ï
            w3 = availableWidth - w1 - w2;
            if (w3 < minW) { // Ïû¨Ï°∞Ï†ïÎêú w3Í∞Ä ÏµúÏÜå ÎÑàÎπÑÎ≥¥Îã§ ÏûëÏúºÎ©¥
                w3 = minW; // w3Î•º ÏµúÏÜå ÎÑàÎπÑÎ°ú ÏÑ§Ï†ï
                const remaining = availableWidth - w3; // w1Í≥º w2Ïóê Ìï†ÎãπÌï† Ïàò ÏûàÎäî ÎÇ®ÏùÄ ÎÑàÎπÑ

                // w1Í≥º w2Î•º ÏõêÎûò ÎπÑÏú®Ïóê Îî∞Îùº ÎÇ®ÏùÄ Í≥µÍ∞ÑÏóê Î∂ÑÎ∞∞
                w1 = Math.floor(remaining * (ratios[0] / (ratios[0] + ratios[1])));
                w2 = remaining - w1;

                // w1Ïù¥ ÏµúÏÜå ÎÑàÎπÑÎ≥¥Îã§ ÏûëÏúºÎ©¥ Ï°∞Ï†ï
                if (w1 < minW) {
                    w1 = minW;
                    w2 = remaining - w1; // w2Î•º Îã§Ïãú Í≥ÑÏÇ∞
                }
                // w2Í∞Ä ÏµúÏÜå ÎÑàÎπÑÎ≥¥Îã§ ÏûëÏúºÎ©¥ Ï°∞Ï†ï (Ïù¥Îïå w1ÎèÑ Îã§Ïãú Í≥ÑÏÇ∞Ìï¥Ïïº Ìï®)
                if (w2 < minW) {
                    w2 = minW;
                    // ÏàòÏ†ïÎêú Î∂ÄÎ∂Ñ: w1ÏùÑ w2Í∞Ä ÏÑ§Ï†ïÎêú ÌõÑ ÎÇ®ÏùÄ Í≥µÍ∞ÑÏúºÎ°ú Ïò¨Î∞îÎ•¥Í≤å Ïû¨Í≥ÑÏÇ∞
                    w1 = remaining - w2;
                }
            }
        }
        panelsArray[0].style.flexBasis = `${w1}px`;
        panelsArray[1].style.flexBasis = `${w2}px`;
        panelsArray[2].style.flexBasis = `${w3}px`;
    }
}

function handleSearchInput() {
    if (!searchInput || !searchTargetSelect || !searchResultsDropdown) return;
    const query = searchInput.value.trim().toLowerCase(); const searchScope = searchTargetSelect.value;
    if (!query) { searchResultsDropdown.innerHTML = ''; searchResultsDropdown.style.display = 'none'; return; }
    if (currentJsonData === null || currentJsonData === undefined) {
        searchController.populateSearchResultsDropdown([{ displayText: "JSON Îç∞Ïù¥ÌÑ∞Î•º Î®ºÏ†Ä Î°úÎìúÌï¥Ï£ºÏÑ∏Ïöî.", noAction: true }], searchResultsDropdown, query, handleSearchResultClick); return;
    }
    const results = searchController.performSearch(query, searchScope, currentJsonData);
    searchController.populateSearchResultsDropdown(results, searchResultsDropdown, query, handleSearchResultClick);
}

function handleSearchResultClick(params) {
    if (params && typeof displayDataInTable === 'function' && params.data !== undefined) {
        displayDataInTable(params.data, params.dataKeyName, params.rootJsonData, params.dataPathString || '');
        if (searchResultsDropdown) searchResultsDropdown.style.display = 'none';
    }
}

function parseCsvLine(line) {
    const values = []; let currentVal = ""; let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') { if (inQuotes && i + 1 < line.length && line[i + 1] === '"') { currentVal += '"'; i++; } else { inQuotes = !inQuotes; } }
        else if (char === ',' && !inQuotes) { values.push(currentVal); currentVal = ""; }
        else { currentVal += char; }
    }
    values.push(currentVal); return values;
}

function autoTypeConvert(value) {
    if (typeof value !== 'string') return value;
    const trimmedValue = value.trim();
    if (trimmedValue.toLowerCase() === 'null') return null;
    if (trimmedValue.toLowerCase() === 'true') return true;
    if (trimmedValue.toLowerCase() === 'false') return false;
    if (trimmedValue === "") return null;
    if (trimmedValue !== '' && !isNaN(Number(trimmedValue))) {
        if (trimmedValue.includes('.') || /^-?\d+$/.test(trimmedValue) || String(Number(trimmedValue)) === trimmedValue.replace(/^0+(?=\d)/, '')) {
            return Number(trimmedValue);
        }
    }
    if ((trimmedValue.startsWith('[') && trimmedValue.endsWith(']')) || (trimmedValue.startsWith('{') && trimmedValue.endsWith('}'))) {
        try { return JSON.parse(trimmedValue); } catch (e) { return trimmedValue; }
    }
    return trimmedValue;
}

function convertCsvToJson(csvString) {
    const allLines = csvString.trim().split(/\r\n|\n|\r/); if (allLines.length === 0) return [];
    let headerLineIndex = -1; for (let i = 0; i < allLines.length; i++) { if (allLines[i].trim() !== "") { headerLineIndex = i; break; } }
    if (headerLineIndex === -1) return [];
    let headers = parseCsvLine(allLines[headerLineIndex]).map((h, index) => { const trimmedHeader = h.trim(); return trimmedHeader === "" ? `column_${index + 1}` : trimmedHeader; });
    const trimmedLowerHeaders = headers.map(h => h.toLowerCase());
    const keyColumnNames = ['key', 'property', 'name', 'field', 'item']; const valueColumnName = 'value';
    const isKeyValueCsv = headers.length === 2 && keyColumnNames.includes(trimmedLowerHeaders[0]) && trimmedLowerHeaders[1] === valueColumnName;

    if (isKeyValueCsv) {
        const singleJsonObject = {};
        for (let i = headerLineIndex + 1; i < allLines.length; i++) {
            const currentLine = allLines[i]; if (currentLine.trim() === "") continue;
            const values = parseCsvLine(currentLine); if (values.every(v => v.trim() === "")) continue;
            if (values.length >= 2) { const key = values[0].trim(); if (key === "") continue; const rawValue = values[1]; singleJsonObject[key] = autoTypeConvert(rawValue); }
        }
        return singleJsonObject;
    } else {
        const jsonData = [];
        for (let i = headerLineIndex + 1; i < allLines.length; i++) {
            const currentLine = allLines[i]; if (currentLine.trim() === "") continue;
            const values = parseCsvLine(currentLine); if (values.every(v => v.trim() === "")) continue;
            const entry = {}; let rowHasMeaningfulData = false; const maxIteration = Math.max(headers.length, values.length);
            for (let j = 0; j < maxIteration; j++) {
                const key = (j < headers.length && headers[j]) ? headers[j] : `column_${j + 1}`;
                const rawValue = values[j] !== undefined ? values[j] : ""; const typedValue = autoTypeConvert(rawValue);
                entry[key] = typedValue; if (typedValue !== null && String(typedValue).trim() !== "") rowHasMeaningfulData = true;
            }
            if (rowHasMeaningfulData) jsonData.push(entry);
        }
        return jsonData;
    }
}

async function loadCsvFromFile() {
    const fileInput = document.createElement('input'); fileInput.type = 'file'; fileInput.accept = '.csv,text/csv'; fileInput.style.display = 'none';
    document.body.appendChild(fileInput);
    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) { if (fileInput.parentNode) fileInput.remove(); return; }
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const csvContent = e.target.result; const conversionResult = convertCsvToJson(csvContent);
                let finalJsonDataToLoad; let feedbackMessage = `${file.name} CSV Î°úÎìú ÏôÑÎ£å.`;
                if (Array.isArray(conversionResult)) {
                    if (conversionResult.length > 0) {
                        finalJsonDataToLoad = conversionResult[0];
                        if (conversionResult.length > 1) feedbackMessage = `${file.name} CSV Î°úÎìúÎê® (Ï£ºÏùò: Ïó¨Îü¨ Î†àÏΩîÎìú Ï§ë Ï≤´ Î≤àÏß∏Îßå ÌëúÏãú).`;
                    } else { finalJsonDataToLoad = []; }
                } else if (typeof conversionResult === 'object' && conversionResult !== null) {
                    finalJsonDataToLoad = conversionResult; feedbackMessage = `${file.name} Key-Value CSVÍ∞Ä Îã®Ïùº JSON Í∞ùÏ≤¥Î°ú Î°úÎìúÎêòÏóàÏäµÎãàÎã§.`;
                } else { finalJsonDataToLoad = {}; feedbackMessage = `${file.name} CSV Î≥ÄÌôò Ï§ë ÏòàÏÉÅÏπò Î™ªÌïú Í≤∞Í≥º.`; }
                const jsonString = JSON.stringify(finalJsonDataToLoad, null, 2);
                if (jsonInputField) { jsonInputField.value = jsonString; loadJson(); showTemporaryMessage(saveFeedback, feedbackMessage, 5000); }
                else { showConfirmationPopup({ title: 'Ïò§Î•ò', text: 'JSON ÏûÖÎ†• ÌïÑÎìúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', icon: 'error', showCancelButton:false, hotInstance: hotInstanceRefForPopups }); }
            } catch (err) {
                if (errorOutput) errorOutput.textContent = `CSV ÌååÏùº ÌååÏã± Ïò§Î•ò: ${err.message}`;
                showConfirmationPopup({ title: 'CSV ÌååÏùº ÌååÏã± Ïò§Î•ò', text: `CSV ÌååÏùºÏùÑ JSONÏúºÎ°ú Î≥ÄÌôò Ï§ë Ïò§Î•ò: ${err.message}`, icon: 'error', showCancelButton:false, hotInstance: hotInstanceRefForPopups });
            } finally { if (fileInput.parentNode) fileInput.remove(); }
        };
        reader.onerror = () => {
            if(errorOutput) errorOutput.textContent = 'CSV ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•ò.';
            showConfirmationPopup({ title: 'CSV ÌååÏùº ÏùΩÍ∏∞ Ïò§Î•ò', text: 'CSV ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', icon: 'error', showCancelButton:false, hotInstance: hotInstanceRefForPopups });
            if (fileInput.parentNode) fileInput.remove();
        };
        reader.readAsText(file);
    });
    fileInput.click();
}

function convertJsonToCSV(jsonData) {
    if (jsonData === null || jsonData === undefined) throw new Error("Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏñ¥ CSVÎ°ú Î≥ÄÌôòÌï† Ïàò ÏóÜÏäµÎãàÎã§.");
    let csvString = "";
    const escapeCSVValue = (value) => {
        if (value === null || value === undefined) return ""; let stringValue;
        if (typeof value === 'object') { stringValue = JSON.stringify(value); } else { stringValue = String(value); }
        if (stringValue.includes(',') || stringValue.includes('\n') || stringValue.includes('\r') || stringValue.includes('"')) {
            stringValue = '"' + stringValue.replace(/"/g, '""') + '"';
        } return stringValue;
    };
    if (Array.isArray(jsonData)) {
        if (jsonData.length === 0) return "";
        if (typeof jsonData[0] === 'object' && jsonData[0] !== null && !Array.isArray(jsonData[0])) {
            const headers = [];
            jsonData.forEach(obj => { if (typeof obj === 'object' && obj !== null) { Object.keys(obj).forEach(key => { if (!headers.includes(key)) headers.push(key); }); } });
            if (headers.length > 0) csvString += headers.map(escapeCSVValue).join(',') + '\r\n';
            else {
                if (jsonData.every(item => typeof item !== 'object' || item === null)) {
                    csvString += "value\r\n"; jsonData.forEach(item => { csvString += escapeCSVValue(item) + '\r\n'; }); return csvString;
                }
            }
            jsonData.forEach(obj => {
                if (typeof obj === 'object' && obj !== null) { const row = headers.map(header => escapeCSVValue(obj[header])); csvString += row.join(',') + '\r\n'; }
                else { const row = headers.map(() => escapeCSVValue(null)); csvString += row.join(',') + '\r\n'; }
            });
        } else { csvString += "value\r\n"; jsonData.forEach(item => { csvString += escapeCSVValue(item) + '\r\n'; }); }
    } else if (typeof jsonData === 'object' && jsonData !== null) {
        csvString += "key,value\r\n"; Object.keys(jsonData).forEach(key => { csvString += escapeCSVValue(key) + ',' + escapeCSVValue(jsonData[key]) + '\r\n'; });
    } else { csvString += "value\r\n"; csvString += escapeCSVValue(jsonData) + '\r\n'; }
    return csvString;
}

async function saveJsonToCSV() {
    if (currentJsonData === null || currentJsonData === undefined) { showTemporaryMessage(saveFeedback, 'Ï†ÄÏû•Ìï† JSON Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.', 3000); return; }
    try {
        const result = await showTextInputPopup({
            title: 'CSV ÌååÏùº Ïù¥Î¶Ñ ÏûÖÎ†•', inputLabel: 'Ï†ÄÏû•Ìï† ÌååÏùº Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî (.csv ÌôïÏû•ÏûêÎäî ÏûêÎèôÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§):', inputValue: 'data', confirmButtonText: 'Ï†ÄÏû•',
            inputValidator: (value) => { if (!value || value.trim().length === 0) return 'ÌååÏùº Ïù¥Î¶ÑÏùÄ ÎπÑÏõåÎëò Ïàò ÏóÜÏäµÎãàÎã§.'; return null; },
            hotInstance: hotInstanceRefForPopups
        });
        if (result.isConfirmed && result.value) {
            let filename = result.value.trim(); if (!filename.toLowerCase().endsWith('.csv')) filename += '.csv';
            const csvString = convertJsonToCSV(currentJsonData);
            const BOM = "\uFEFF"; // BOM for UTF-8 for Excel compatibility
            const blob = new Blob([BOM + csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob); const a = document.createElement('a');
            a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            showTemporaryMessage(saveFeedback, `${filename} ÌååÏùºÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú CSVÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!`, 3000);
        } else { showTemporaryMessage(saveFeedback, 'CSV ÌååÏùº Ï†ÄÏû•Ïù¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.', 3000); }
    } catch (e) {
        if(errorOutput) errorOutput.textContent = 'CSV ÌååÏùº Ï†ÄÏû•/Î≥ÄÌôò Ïò§Î•ò: ' + e.message;
        showConfirmationPopup({ title: 'CSV Ï†ÄÏû•/Î≥ÄÌôò Ïò§Î•ò', text: `JSON Îç∞Ïù¥ÌÑ∞Î•º CSVÎ°ú Ï†ÄÏû•/Î≥ÄÌôò Ï§ë Ïò§Î•ò: ${e.message}`, icon: 'error', showCancelButton:false, hotInstance: hotInstanceRefForPopups });
    }
}

function loadJsonFromFile() {
    const fileInput = document.createElement('input'); fileInput.type = 'file'; fileInput.accept = '.json,application/json'; fileInput.style.display = 'none';
    document.body.appendChild(fileInput);
    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) { if (fileInput.parentNode) fileInput.remove(); return; }
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const fileContent = e.target.result;
                if (jsonInputField) { jsonInputField.value = fileContent; loadJson(); showTemporaryMessage(saveFeedback, `${file.name} ÌååÏùºÏù¥ Î°úÎìúÎêòÏóàÏäµÎãàÎã§.`, 3000); }
                else { showConfirmationPopup({ title: 'Ïò§Î•ò', text: 'JSON ÏûÖÎ†• ÌïÑÎìúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', icon: 'error', showCancelButton:false, hotInstance: hotInstanceRefForPopups }); }
            } catch (err) {
                if(errorOutput) errorOutput.textContent = `ÌååÏùº Ïò§Î•ò: ${err.message}`;
                showConfirmationPopup({ title: 'ÌååÏùº Î°úÎìú Ïò§Î•ò', text: `ÌååÏùºÏùÑ Î°úÎìúÌïòÍ±∞ÎÇò ÌååÏã±ÌïòÎäî Ï§ë Ïò§Î•ò: ${err.message}`, icon: 'error', showCancelButton:false, hotInstance: hotInstanceRefForPopups });
            } finally { if (fileInput.parentNode) fileInput.remove(); }
        };
        reader.onerror = () => {
            if(errorOutput) errorOutput.textContent = 'ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•ò.';
            showConfirmationPopup({ title: 'ÌååÏùº ÏùΩÍ∏∞ Ïò§Î•ò', text: 'ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', icon: 'error', showCancelButton:false, hotInstance: hotInstanceRefForPopups });
            if (fileInput.parentNode) fileInput.remove();
        };
        reader.readAsText(file);
    });
    fileInput.click();
}

async function saveJsonToFile() {
    if (currentJsonData === null || currentJsonData === undefined) { showTemporaryMessage(saveFeedback, 'Ï†ÄÏû•Ìï† JSON Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.', 3000); return; }
    try {
        const result = await showTextInputPopup({
            title: 'ÌååÏùº Ïù¥Î¶Ñ ÏûÖÎ†•', inputLabel: 'Ï†ÄÏû•Ìï† ÌååÏùº Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî (.json ÌôïÏû•ÏûêÎäî ÏûêÎèôÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§):', inputValue: 'data', confirmButtonText: 'Ï†ÄÏû•',
            inputValidator: (value) => { if (!value || value.trim().length === 0) return 'ÌååÏùº Ïù¥Î¶ÑÏùÄ ÎπÑÏõåÎëò Ïàò ÏóÜÏäµÎãàÎã§.'; return null; },
            hotInstance: hotInstanceRefForPopups
        });
        if (result.isConfirmed && result.value) {
            let filename = result.value.trim(); if (!filename.toLowerCase().endsWith('.json')) filename += '.json';
            const jsonString = JSON.stringify(currentJsonData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' }); const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            showTemporaryMessage(saveFeedback, `${filename} ÌååÏùºÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!`, 3000);
        } else { showTemporaryMessage(saveFeedback, 'ÌååÏùº Ï†ÄÏû•Ïù¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.', 3000); }
    } catch (e) {
        if(errorOutput) errorOutput.textContent = 'JSON ÌååÏùº Ï†ÄÏû• Ïò§Î•ò: ' + e.message;
        showConfirmationPopup({ title: 'ÌååÏùº Ï†ÄÏû• Ïò§Î•ò', text: `JSON Îç∞Ïù¥ÌÑ∞Î•º ÌååÏùºÎ°ú Ï†ÄÏû• Ï§ë Ïò§Î•ò: ${e.message}`, icon: 'error', showCancelButton:false, hotInstance: hotInstanceRefForPopups });
    }
}

async function loadTemplatesFromFile() {
    const fileInput = document.createElement('input'); fileInput.type = 'file'; fileInput.accept = '.json,application/json'; fileInput.style.display = 'none';
    document.body.appendChild(fileInput);

    fileInput.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) { if (fileInput.parentNode) fileInput.remove(); return; }
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const fileContent = e.target.result;
                const loadedTemplatesArray = JSON.parse(fileContent);
                if (!Array.isArray(loadedTemplatesArray)) throw new Error("ÌÖúÌîåÎ¶ø ÌååÏùºÏùÄ Î∞∞Ïó¥ ÌòïÌÉúÏó¨Ïïº Ìï©ÎãàÎã§.");

                const existingUserNames = templateManager.getUserTemplates().map(t => t.name);

                const popupResult = await showTemplateSelectionPopup({
                    title: `'${file.name}' ÌååÏùºÏóêÏÑú ÌÖúÌîåÎ¶ø Î∂àÎü¨Ïò§Í∏∞`, templates: loadedTemplatesArray,
                    message: 'ÏïÑÎûò Î™©Î°ùÏóêÏÑú Î∂àÎü¨Ïò¨ ÌÖúÌîåÎ¶øÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî. <span style="color: var(--color-warning, orange); font-weight:bold;">(ÎçÆÏñ¥ÏîÄ)</span> ÌëúÏãúÎäî Ïù¥Î¶ÑÏù¥ Í∞ôÏùÄ Í∏∞Ï°¥ ÏÇ¨Ïö©Ïûê ÌÖúÌîåÎ¶øÏùÑ Ïù¥ ÌååÏùºÏùò ÎÇ¥Ïö©ÏúºÎ°ú Î≥ÄÍ≤ΩÌï®ÏùÑ ÏùòÎØ∏Ìï©ÎãàÎã§.',
                    confirmButtonText: 'ÏÑ†ÌÉùÌïú ÌÖúÌîåÎ¶ø Î∂àÎü¨Ïò§Í∏∞', cancelButtonText: 'Ï∑®ÏÜå',
                    hotInstance: hotInstanceRefForPopups, existingUserTemplateNames: existingUserNames
                });

                if (popupResult.isConfirmed) {
                    if (popupResult.selectedTemplates.length > 0) {
                        const count = templateManager.loadSelectedUserTemplates(popupResult.selectedTemplates);
                        showTemporaryMessage(saveFeedback, `ÏÑ†ÌÉùÎêú ${count}Í∞úÏùò ÏÇ¨Ïö©Ïûê ÌÖúÌîåÎ¶øÏùÑ '${file.name}'ÏóêÏÑú Î°úÎìú Î∞è Î≥ëÌï©ÌñàÏäµÎãàÎã§.`, 3000);
                    } else { showTemporaryMessage(saveFeedback, 'ÏÑ†ÌÉùÎêú ÌÖúÌîåÎ¶øÏù¥ ÏóÜÏñ¥ ÏïÑÎ¨¥Í≤ÉÎèÑ Î°úÎìúÌïòÏßÄ ÏïäÏïòÏäµÎãàÎã§.', 3000, 'info'); }
                } else { showTemporaryMessage(saveFeedback, 'ÌÖúÌîåÎ¶ø ÌååÏùº Î°úÎìúÍ∞Ä Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.', 3000, 'info'); }
            } catch (err) {
                if(errorOutput) errorOutput.textContent = `ÌÖúÌîåÎ¶ø ÌååÏùº Ï≤òÎ¶¨ Ïò§Î•ò: ${err.message}`;
                showConfirmationPopup({ title: 'ÌÖúÌîåÎ¶ø ÌååÏùº Ï≤òÎ¶¨ Ïò§Î•ò', text: `ÌÖúÌîåÎ¶ø ÌååÏùºÏùÑ Ï≤òÎ¶¨ÌïòÎäî Ï§ë Ïò§Î•ò: ${err.message}`, icon: 'error', showCancelButton:false, hotInstance: hotInstanceRefForPopups });
            } finally { if (fileInput.parentNode) fileInput.remove(); }
        };
        reader.onerror = () => {
            if(errorOutput) errorOutput.textContent = 'ÌÖúÌîåÎ¶ø ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•ò.';
            showConfirmationPopup({ title: 'ÌååÏùº ÏùΩÍ∏∞ Ïò§Î•ò', text: 'ÌÖúÌîåÎ¶ø ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', icon: 'error', showCancelButton:false, hotInstance: hotInstanceRefForPopups });
            if (fileInput.parentNode) fileInput.remove();
        };
        reader.readAsText(file);
    });
    fileInput.click();
}

async function saveTemplatesToFile() {
    const userTemplates = templateManager.getUserTemplates();
    if (!userTemplates || userTemplates.length === 0) { showTemporaryMessage(saveFeedback, 'Ï†ÄÏû•Ìï† ÏÇ¨Ïö©Ïûê Ï†ïÏùò ÌÖúÌîåÎ¶øÏù¥ ÏóÜÏäµÎãàÎã§.', 3000, 'info'); return; }
    try {
        const popupResult = await showTemplateSelectionPopup({
            title: 'ÌååÏùºÎ°ú Ï†ÄÏû•Ìï† ÌÖúÌîåÎ¶ø ÏÑ†ÌÉù', templates: userTemplates, message: 'ÌååÏùºÎ°ú Ï†ÄÏû•Ìï† ÏÇ¨Ïö©Ïûê Ï†ïÏùò ÌÖúÌîåÎ¶øÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.',
            confirmButtonText: 'ÏÑ†ÌÉùÌïú ÌÖúÌîåÎ¶ø Ï†ÄÏû•ÌïòÍ∏∞', cancelButtonText: 'Ï∑®ÏÜå', hotInstance: hotInstanceRefForPopups
        });

        if (popupResult.isConfirmed && popupResult.selectedTemplates.length > 0) {
            const selectedUserTemplatesToSave = popupResult.selectedTemplates.map(({ name, type, value }) => ({ name, type, value }));
            const filenameResult = await showTextInputPopup({
                title: 'ÌÖúÌîåÎ¶ø ÌååÏùº Ïù¥Î¶Ñ ÏûÖÎ†•', inputLabel: 'Ï†ÄÏû•Ìï† ÌÖúÌîåÎ¶ø ÌååÏùº Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî (.json ÌôïÏû•ÏûêÎäî ÏûêÎèôÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§):',
                inputValue: 'user_templates', confirmButtonText: 'Ï†ÄÏû•',
                inputValidator: (value) => { if (!value || value.trim().length === 0) return 'ÌååÏùº Ïù¥Î¶ÑÏùÄ ÎπÑÏõåÎëò Ïàò ÏóÜÏäµÎãàÎã§.'; return null; },
                hotInstance: hotInstanceRefForPopups
            });
            if (filenameResult.isConfirmed && filenameResult.value) {
                let filename = filenameResult.value.trim(); if (!filename.toLowerCase().endsWith('.json')) filename += '.json';
                const jsonString = JSON.stringify(selectedUserTemplatesToSave, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' }); const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                showTemporaryMessage(saveFeedback, `ÏÑ†ÌÉùÎêú ÏÇ¨Ïö©Ïûê ÌÖúÌîåÎ¶øÏù¥ ${filename} ÌååÏùºÎ°ú ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!`, 3000);
            } else { showTemporaryMessage(saveFeedback, 'ÌÖúÌîåÎ¶ø ÌååÏùº Ïù¥Î¶Ñ ÏûÖÎ†•Ïù¥ Ï∑®ÏÜåÎêòÏñ¥ Ï†ÄÏû•Ïù¥ Ï§ëÎã®ÎêòÏóàÏäµÎãàÎã§.', 3000, 'info'); }
        } else if (popupResult.isConfirmed && popupResult.selectedTemplates.length === 0 ) {
            showTemporaryMessage(saveFeedback, 'ÏÑ†ÌÉùÎêú ÌÖúÌîåÎ¶øÏù¥ ÏóÜÏñ¥ ÏïÑÎ¨¥Í≤ÉÎèÑ Ï†ÄÏû•ÌïòÏßÄ ÏïäÏïòÏäµÎãàÎã§.', 3000, 'info');
        } else if (popupResult.isDismissed) {
            showTemporaryMessage(saveFeedback, 'ÌÖúÌîåÎ¶ø ÌååÏùº Ï†ÄÏû•Ïù¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.', 3000, 'info');
        }
    } catch (e) {
        if(errorOutput) errorOutput.textContent = 'ÌÖúÌîåÎ¶ø ÌååÏùº Ï†ÄÏû• Ïò§Î•ò: ' + e.message;
        showConfirmationPopup({ title: 'ÌÖúÌîåÎ¶ø ÌååÏùº Ï†ÄÏû• Ïò§Î•ò', text: `ÌÖúÌîåÎ¶øÏùÑ ÌååÏùºÎ°ú Ï†ÄÏû•ÌïòÎäî Ï§ë Ïò§Î•ò: ${e.message}`, icon: 'error', showCancelButton:false, hotInstance: hotInstanceRefForPopups });
    }
}

function loadJson() {
    resetUI(); historyManager.clearHistory();
    try {
        const jsonString = jsonInputField.value.trim();
        if (!jsonString) { currentJsonData = null; originalJsonDataAtLoad = null; updateTableViewPathDisplay(null, handlePathSegmentClicked); destroyHotInstanceAndUpdateRef(); return; }
        currentJsonData = JSON.parse(jsonString); originalJsonDataAtLoad = JSON.parse(JSON.stringify(currentJsonData)); // Deep copy for diff
        const configForTree = buildTreeConfigObj(); if (treeViewContainer) treeViewContainer.innerHTML = '';
        if (typeof currentJsonData === 'object' && currentJsonData !== null) buildTree(currentJsonData, treeViewContainer, '', currentJsonData, 0, configForTree);
        else { const tempRootKey = 'value'; const tempData = { [tempRootKey]: currentJsonData }; buildTree(tempData, treeViewContainer, '', tempData, 0, configForTree); }
        destroyHotInstanceAndUpdateRef(); updateTableViewPathDisplay(null, handlePathSegmentClicked);
    } catch (e) {
        if(errorOutput) errorOutput.textContent = 'JSON ÌååÏã± Ïò§Î•ò: ' + e.message; currentJsonData = null; originalJsonDataAtLoad = null;
        if(treeViewContainer) treeViewContainer.innerHTML = ''; destroyHotInstanceAndUpdateRef(); updateTableViewPathDisplay(null, handlePathSegmentClicked);
    }
}

function saveJson() {
    if(errorOutput) errorOutput.textContent = '';
    if (currentJsonData !== null && currentJsonData !== undefined) {
        try { const jsonString = JSON.stringify(currentJsonData, null, 2); if(jsonInputField) jsonInputField.value = jsonString; if(saveFeedback) showTemporaryMessage(saveFeedback, 'JSONÏù¥ ÌÖçÏä§Ìä∏ ÏòÅÏó≠Ïóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!', 3000); }
        catch (e) { if(errorOutput) errorOutput.textContent = 'JSON Î¨∏ÏûêÏó¥ Î≥ÄÌôò Ïò§Î•ò: ' + e.message; if(saveFeedback) saveFeedback.textContent = ''; }
    } else { if(jsonInputField) jsonInputField.value = ''; if(saveFeedback) showTemporaryMessage(saveFeedback, 'Ï†ÄÏû•Ìï† JSON Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.', 3000); }
}

function resetUI() {
    resetBaseUI(); destroyHotInstanceAndUpdateRef(); currentJsonData = null; originalJsonDataAtLoad = null; selectNode(null);
    if (searchResultsDropdown) { searchResultsDropdown.innerHTML = ''; searchResultsDropdown.style.display = 'none'; }
    if(searchInput) searchInput.value = ''; if(treeViewContainer) treeViewContainer.innerHTML = ''; updateTableViewPathDisplay(null, handlePathSegmentClicked);
}

function destroyHotInstanceAndUpdateRef() {
    hotInstanceRefForPopups = destroyHotInstance();
}

function updateJsonData(pathString, newValueString, isBatchOperation = false) {
    if (currentJsonData === null || currentJsonData === undefined) { return; }
    const keys = pathString.replace(/\[(\d+)\]/g, '.$1').split('.'); const lastKeyOrIndexString = keys.pop(); const parentPath = keys.join('.');
    let parentObject; if (parentPath === "") parentObject = currentJsonData; else parentObject = getObjectByPath(currentJsonData, parentPath);
    if (parentPath === "" && pathString === lastKeyOrIndexString && (typeof currentJsonData !== 'object' || currentJsonData === null)) {
        currentJsonData = convertToTypedValue(newValueString, currentJsonData); if (isBatchOperation) return; refreshTreeView(pathString);
        displayDataInTable(currentJsonData, 'value', currentJsonData, ''); return;
    }
    if (!parentObject || (typeof parentObject !== 'object' && !Array.isArray(parentObject))) {
        showConfirmationPopup({ title: 'Ïò§Î•ò', text: 'Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§ (Î∂ÄÎ™® Í≤ΩÎ°ú ÌôïÏù∏ ÌïÑÏöî).', icon: 'error', showCancelButton: false, hotInstance: hotInstanceRefForPopups }); return;
    }
    const targetKeyOrIndex = /^\d+$/.test(lastKeyOrIndexString) && Array.isArray(parentObject) ? parseInt(lastKeyOrIndexString, 10) : lastKeyOrIndexString;
    if (Array.isArray(parentObject) && (targetKeyOrIndex < 0 || targetKeyOrIndex >= parentObject.length)) {
        showConfirmationPopup({ title: 'Ïò§Î•ò', text: 'Î∞∞Ïó¥ Ïù∏Îç±Ïä§ Î≤îÏúÑÎ•º Î≤óÏñ¥ÎÇ¨ÏäµÎãàÎã§.', icon: 'error', showCancelButton: false, hotInstance: hotInstanceRefForPopups }); return;
    }
    let fullRebuildNeeded = true; const originalValue = parentObject[targetKeyOrIndex];
    const typedValue = convertToTypedValue(String(newValueString), originalValue); parentObject[targetKeyOrIndex] = typedValue;
    if (!isBatchOperation) {
        const wasPrimitive = typeof originalValue !== 'object' || originalValue === null;
        const isNowPrimitive = typeof typedValue !== 'object' || typedValue === null;
        if (wasPrimitive && isNowPrimitive && treeViewContainer) {
            const nodeElement = treeViewContainer.querySelector(`.tree-node[data-path="${pathString}"]`);
            if (nodeElement) { const valueSpan = nodeElement.querySelector('.node-text-wrapper .tree-node-value'); if (valueSpan) { applyValueStyleToNode(valueSpan, typedValue); fullRebuildNeeded = false; } }
        }
    } else return;
    if (!isBatchOperation && fullRebuildNeeded) {
        refreshTreeView(pathString);
    }
}

function updateJsonKey(parentPathString, oldKey, newKey, directParentObjectRef) {
    let parentObject;
    if (directParentObjectRef && (parentPathString === "" || getObjectByPath(currentJsonData, parentPathString) === directParentObjectRef)) parentObject = directParentObjectRef;
    else parentObject = (parentPathString === "") ? currentJsonData : getObjectByPath(currentJsonData, parentPathString);
    if (typeof parentObject !== 'object' || parentObject === null || Array.isArray(parentObject)) {
        showConfirmationPopup({ title: 'Ïò§Î•ò', text: 'ÌÇ§Î•º ÏóÖÎç∞Ïù¥Ìä∏Ìï† Î∂ÄÎ™® Í∞ùÏ≤¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', icon: 'error', showCancelButton: false, hotInstance: hotInstanceRefForPopups }); return;
    }
    if (!Object.prototype.hasOwnProperty.call(parentObject, oldKey)) { showConfirmationPopup({ title: 'Ïò§Î•ò', text: `Í∏∞Ï°¥ ÌÇ§ "${oldKey}"Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.`, icon: 'error', showCancelButton: false, hotInstance: hotInstanceRefForPopups }); return; }
    if (newKey === oldKey) { showConfirmationPopup({icon: 'info', title: 'ÏïåÎ¶º', text: 'ÌÇ§ Ïù¥Î¶ÑÏóê Î≥ÄÍ≤ΩÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§.', showCancelButton: false, hotInstance: hotInstanceRefForPopups}); return; }
    if (Object.prototype.hasOwnProperty.call(parentObject,newKey)) { showConfirmationPopup({ title: 'Ïò§Î•ò', text: `ÏÉà ÌÇ§ "${newKey}"Í∞Ä Ïù¥ÎØ∏ ÌòÑÏû¨ Í∞ùÏ≤¥Ïóê Ï°¥Ïû¨Ìï©ÎãàÎã§.`, icon: 'error', showCancelButton: false, hotInstance: hotInstanceRefForPopups }); return; }
    const newOrderedObject = {}; const valueToMove = parentObject[oldKey];
    for (const currentKeyInLoop in parentObject) if (Object.prototype.hasOwnProperty.call(parentObject,currentKeyInLoop)) { if (currentKeyInLoop === oldKey) newOrderedObject[newKey] = valueToMove; else newOrderedObject[currentKeyInLoop] = parentObject[currentKeyInLoop]; }
    for (const keyInParent in parentObject) if (Object.prototype.hasOwnProperty.call(parentObject,keyInParent)) delete parentObject[keyInParent];
    for (const keyInNewOrder in newOrderedObject) if (Object.prototype.hasOwnProperty.call(newOrderedObject,keyInNewOrder)) parentObject[keyInNewOrder] = newOrderedObject[keyInNewOrder];
    showConfirmationPopup({icon: 'success', title: 'ÏÑ±Í≥µ', text: `ÌÇ§ "${oldKey}"Í∞Ä "${newKey}"(Ïúº)Î°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`, showCancelButton: false, hotInstance: hotInstanceRefForPopups});
    refreshTreeView(`key_renamed_in_parent:${parentPathString}`);
    displayDataInTable(parentObject, newKey, currentJsonData, parentPathString);
}

export function refreshTreeView(changedPathForLog = "N/A") {
    if (treeViewContainer && !(currentJsonData === null || currentJsonData === undefined)) {
        const selectedPath = getSelectedNodePath(); const expandedPaths = getExpandedNodePaths(treeViewContainer);
        treeViewContainer.innerHTML = ''; const configForTree = buildTreeConfigObj();
        if (typeof currentJsonData === 'object' && currentJsonData !== null) buildTree(currentJsonData, treeViewContainer, '', currentJsonData, 0, configForTree);
        else { const tempRootKey = (typeof changedPathForLog === 'string' && changedPathForLog !== "N/A" && !changedPathForLog.includes('.')) ? changedPathForLog : 'value'; const tempRootData = {[tempRootKey]: currentJsonData}; buildTree(tempRootData, treeViewContainer, '', tempRootData, 0, configForTree); }
        expandNodesByPath(treeViewContainer, expandedPaths);
        if (selectedPath) { const reSelectedNode = treeViewContainer.querySelector(`.tree-node[data-path="${selectedPath}"]`); if (reSelectedNode) selectNode(reSelectedNode); }
    } else if (treeViewContainer) treeViewContainer.innerHTML = '';
}

function buildTreeConfigObj() {
    return { displayTableCallback: displayDataInTable, getObjectByPathCallback: getObjectByPath, rootJsonData: currentJsonData };
}

function handlePathSegmentClicked(path) {
    const dataForTable = getObjectByPath(currentJsonData, path);
    if (dataForTable !== undefined) {
        let newKeyName = 'context';
        if (path === '') newKeyName = 'root';
        else { const lastDot = path.lastIndexOf('.'); const lastBracketOpen = path.lastIndexOf('[');
            if (lastBracketOpen > -1 && path.endsWith(']')) { if (lastBracketOpen > lastDot) newKeyName = path.substring(lastBracketOpen + 1, path.length - 1); else newKeyName = path.substring(lastDot + 1); }
            else if (lastDot > -1) newKeyName = path.substring(lastDot + 1);
            else newKeyName = path;
        }
        displayDataInTable(dataForTable, newKeyName, currentJsonData, path, { syncTreeView: true });
    } else {
        showConfirmationPopup({ title: 'Ïò§Î•ò', text: `Í≤ΩÎ°ú '${path}'Ïóê Ìï¥ÎãπÌïòÎäî Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.`, icon: 'error', showCancelButton: false, hotInstance: hotInstanceRefForPopups });
    }
}

export function displayDataInTable(dataToDisplay, dataKeyNameToUse, rootJsonDataForContext, dataPathStringToRecord, options = { syncTreeView: true }) {
    historyManager.addStateToHistory({ dataPathString: dataPathStringToRecord, dataKeyName: dataKeyNameToUse });
    updateTableViewPathDisplay(dataPathStringToRecord, handlePathSegmentClicked);
    const configForTable = {
        tableViewDomElement: tableViewContainer,
        updateJsonDataCallback: updateJsonData,
        updateJsonKeyCallback: updateJsonKey,
        refreshTreeViewCallback: refreshTreeView,
        getObjectByPathCallback: getObjectByPath,
        convertToTypedValueCallback: convertToTypedValue,
        rootJsonData: rootJsonDataForContext,
        currentJsonDataRef: () => currentJsonData,
        dataPathString: dataPathStringToRecord,
        displayTableCallback: displayDataInTable,
        getTemplates: templateManager.getTemplates,
        addTemplate: templateManager.addTemplate
    };
    hotInstanceRefForPopups = displayTableInHot(dataToDisplay, dataKeyNameToUse, configForTable);

    if (options.syncTreeView && treeViewContainer && dataPathStringToRecord !== undefined && dataPathStringToRecord !== null) {
        const targetNodeElement = treeViewContainer.querySelector(`.tree-node[data-path="${dataPathStringToRecord}"]`);
        if (targetNodeElement) {
            selectNode(targetNodeElement);
            setTimeout(() => {
                const finalTargetNode = treeViewContainer.querySelector(`.tree-node[data-path="${dataPathStringToRecord}"]`);
                if (finalTargetNode) {
                    finalTargetNode.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 50);
        } else if (dataPathStringToRecord === "") {
            selectNode(null); if (treeViewContainer.firstChild) treeViewContainer.scrollTop = 0;
        }
    }
}

function navigateHistory(direction) {
    const restoredPathInfo = historyManager.getNavigationState(direction);
    if (restoredPathInfo) {
        historyManager.setNavigationInProgress(true);
        try {
            const dataForPath = getObjectByPath(currentJsonData, restoredPathInfo.dataPathString);
            displayDataInTable(
                dataForPath,
                restoredPathInfo.dataKeyName,
                currentJsonData,
                restoredPathInfo.dataPathString,
                { syncTreeView: false }
            );
        } catch (error) {
            showConfirmationPopup({ title: 'Ïò§Î•ò', text: 'ÌûàÏä§ÌÜ†Î¶¨ Î≥µÏõê Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', icon: 'error', showCancelButton: false, hotInstance: hotInstanceRefForPopups });
        } finally {
            historyManager.setNavigationInProgress(false);
        }
    }
}

document.addEventListener('DOMContentLoaded', initialLoad);